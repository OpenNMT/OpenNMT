
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <link rel="shortcut icon" href="../../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.3, mkdocs-material-1.10.2">
    
    
      
        <title>Data sampling - OpenNMT</title>
      
    
    
      <script src="../../assets/javascripts/modernizr-e826f8942a.js"></script>
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application-408828a02a.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.4/css/select2.min.css">
    
    
  </head>
  
  
  
  
    <body>
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="OpenNMT" class="md-header-nav__button md-logo">
          
            
              <img src="../../img/logo-alpha.png" width="24" height="24">
            
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  Training
                </span>
              
            
            Data sampling
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="" data-md-lang-tokenizer="[\s\-]+">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/OpenNMT/OpenNMT" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      OpenNMT/OpenNMT
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <div class="md-nav__button md-logo">
      
        
          <img src="../../img/logo-alpha.png">
        
      
    </div>
    OpenNMT
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/OpenNMT/OpenNMT" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      OpenNMT/OpenNMT
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../installation/" title="Installation" class="md-nav__link">
      Installation
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../quickstart/" title="Quickstart" class="md-nav__link">
      Quickstart
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../applications/" title="Applications" class="md-nav__link">
      Applications
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Data
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Data
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../data/preparation/" title="Preparation" class="md-nav__link">
      Preparation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../data/word_features/" title="Word features" class="md-nav__link">
      Word features
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" checked>
    
    <label class="md-nav__link" for="nav-6">
      Training
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Training
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../models/" title="Models" class="md-nav__link">
      Models
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../embeddings/" title="Embeddings" class="md-nav__link">
      Embeddings
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../logs/" title="Logs" class="md-nav__link">
      Logs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../multi_gpu/" title="Multi GPU" class="md-nav__link">
      Multi GPU
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../retraining/" title="Retraining" class="md-nav__link">
      Retraining
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../regularization/" title="Regularization" class="md-nav__link">
      Regularization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../decay/" title="Decay strategies" class="md-nav__link">
      Decay strategies
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Data sampling
      </label>
    
    <a href="./" title="Data sampling" class="md-nav__link md-nav__link--active">
      Data sampling
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#importance-sampling" title="Importance Sampling" class="md-nav__link">
    Importance Sampling
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#memory-sampling" title="Memory Sampling" class="md-nav__link">
    Memory Sampling
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uniform" title="Uniform" class="md-nav__link">
    Uniform
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#perplexity-based" title="Perplexity-based" class="md-nav__link">
    Perplexity-based
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#partition" title="Partition" class="md-nav__link">
    Partition
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#file-sampling" title="File Sampling" class="md-nav__link">
    File Sampling
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dynamic-dataset" title="Dynamic Dataset" class="md-nav__link">
    Dynamic Dataset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sampling-distribution-rules" title="Sampling distribution rules" class="md-nav__link">
    Sampling distribution rules
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Translation
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Translation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../translation/inference/" title="Inference" class="md-nav__link">
      Inference
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translation/beam_search/" title="Beam search" class="md-nav__link">
      Beam search
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../translation/unknowns/" title="Unknown words" class="md-nav__link">
      Unknown words
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Tools
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        Tools
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../tools/tokenization/" title="Tokenization" class="md-nav__link">
      Tokenization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tools/scorer/" title="Scorer" class="md-nav__link">
      Scorer
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tools/servers/" title="Servers" class="md-nav__link">
      Servers
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Reference: Options
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        Reference: Options
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../options/usage/" title="Scripts usage" class="md-nav__link">
      Scripts usage
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../options/preprocess/" title="preprocess.lua" class="md-nav__link">
      preprocess.lua
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../options/train/" title="train.lua" class="md-nav__link">
      train.lua
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../options/translate/" title="translate.lua" class="md-nav__link">
      translate.lua
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../options/tag/" title="tag.lua" class="md-nav__link">
      tag.lua
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../options/lm/" title="lm.lua" class="md-nav__link">
      lm.lua
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../options/build_vocab/" title="tools/build_vocab.lua" class="md-nav__link">
      tools/build_vocab.lua
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../options/release_model/" title="tools/release_model.lua" class="md-nav__link">
      tools/release_model.lua
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../options/tokenize/" title="tools/tokenize.lua" class="md-nav__link">
      tools/tokenize.lua
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../options/learn_bpe/" title="tools/learn_bpe.lua" class="md-nav__link">
      tools/learn_bpe.lua
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../options/server/" title="tools/translation_server.lua" class="md-nav__link">
      tools/translation_server.lua
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../options/rest_server/" title="tools/rest_translation_server.lua" class="md-nav__link">
      tools/rest_translation_server.lua
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../options/embeddings/" title="tools/embeddings.lua" class="md-nav__link">
      tools/embeddings.lua
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../options/average_models/" title="tools/average_models.lua" class="md-nav__link">
      tools/average_models.lua
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../lua_python_comparison/" title="Lua and Python OpenNMT" class="md-nav__link">
      Lua and Python OpenNMT
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../references/" title="References" class="md-nav__link">
      References
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../issues/" title="Common issues" class="md-nav__link">
      Common issues
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#importance-sampling" title="Importance Sampling" class="md-nav__link">
    Importance Sampling
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#memory-sampling" title="Memory Sampling" class="md-nav__link">
    Memory Sampling
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#uniform" title="Uniform" class="md-nav__link">
    Uniform
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#perplexity-based" title="Perplexity-based" class="md-nav__link">
    Perplexity-based
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#partition" title="Partition" class="md-nav__link">
    Partition
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#file-sampling" title="File Sampling" class="md-nav__link">
    File Sampling
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dynamic-dataset" title="Dynamic Dataset" class="md-nav__link">
    Dynamic Dataset
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sampling-distribution-rules" title="Sampling distribution rules" class="md-nav__link">
    Sampling distribution rules
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/OpenNMT/OpenNMT/edit/master/docs/training/sampling.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>Data sampling</h1>
                
                <p>Data sampling is a technique to select a subset of the training set at each epoch. This could be a way to make the epoch unit smaller or select relevant training sequences at each epoch. This is also necessary for working on very large dataset - where the full data does not need to be loaded in memory for each epoch. There are two implementations for sampling: <em>memory sampling</em> and <em>file sampling</em>.</p>
<p>Both implementations also support vocabulary sampling (also called <em>Importance Sampling</em>).</p>
<h2 id="importance-sampling">Importance Sampling<a class="headerlink" href="#importance-sampling" title="Permanent link">&para;</a></h2>
<p>When sampling, with the option <code>-sample_vocab</code> it is also possible to restrict the generated vocabulary to the current sample which gives an approximate of the full softmax as defined here <a href="http://www.aclweb.org/anthology/P15-1001">Jean et al, 2015</a> via an "importance sampling" approach.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Importance sampling is particularly useful when training systems with very large output vocabulary for faster computation.</p>
</div>
<h2 id="memory-sampling">Memory Sampling<a class="headerlink" href="#memory-sampling" title="Permanent link">&para;</a></h2>
<p><em>Memory Sampling</em> is enabled using <code>-sample N</code> option where <script type="math/tex">N</script> is the number of sequences to select at each epoch. There are different methods for selecting these <script type="math/tex">N</script> sentences corresponding to the <code>-sample_type</code> option: <code>uniform</code> (default), <code>perplexity</code> or <code>partition</code>.</p>
<h3 id="uniform">Uniform<a class="headerlink" href="#uniform" title="Permanent link">&para;</a></h3>
<p>The simplest data sampling is to uniformly select a subset of the training data. Using the <code>-sample N</code> option, the training will randomly choose <script type="math/tex">N</script> training sequences at each epoch.</p>
<p>A typical use case is to reduce the length of the epochs for more frequent learning rate updates and validation perplexity computation.</p>
<h3 id="perplexity-based">Perplexity-based<a class="headerlink" href="#perplexity-based" title="Permanent link">&para;</a></h3>
<p>This approach is an attempt to feed relevant training data at each epoch. When using the flag <code>-sample_type perplexity</code>, the perplexity of each sequence is used to generate a multinomial probability distribution over the training sequences. The higher the perplexity, the more likely the sequence is selected.</p>
<p>Alternatively, perplexity-based sampling can be enabled when an average training perplexity is met with the <code>-sample_perplexity_init</code> option.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This perplexity-based approach is experimental and effects are to be experimented. This also results in a ~10% slowdown as the perplexity of <strong>each</strong> sequence has to be independently computed.</p>
</div>
<h3 id="partition">Partition<a class="headerlink" href="#partition" title="Permanent link">&para;</a></h3>
<p>When using the flag <code>-sample_type partition</code>, samples are drawn without random, uniformally and incrementally from the corpus training. Use this mode for making sure all training sequences will be sent the same number of time.</p>
<h2 id="file-sampling">File Sampling<a class="headerlink" href="#file-sampling" title="Permanent link">&para;</a></h2>
<p><em>File Sampling</em> is enabled using <code>-gsample V</code> option: <script type="math/tex">V</script> is either an integer and in that case it represents the number of sentences to sample from the dataset, or a float values and in that case, it represents a relative size based on the full dataset size (e.g: 0.1 being 10%).</p>
<p>File Sampling can only be used with on-the-fly preprocessing and tokenization as an alternative to sequential tokenization, preprocessing, training - and this is refers as <em>Dynamic Dataset</em> below.</p>
<p>In <em>File Sampling</em>, the only available sampling method is uniform meaning that the sentences are selected uniformly in each corpus of the dataset. However, it is possible to modify the distribution of the sampling for the different files using sampling rule file as described below.</p>
<h3 id="dynamic-dataset">Dynamic Dataset<a class="headerlink" href="#dynamic-dataset" title="Permanent link">&para;</a></h3>
<p>It is possible to provide raw files directly to training script. For that, instead of using the <code>-data D</code> option, you have to use preprocessing data selection options (such as <code>-train_src</code>, <code>-train_tgt</code>, or <code>-training_dir</code> option). Note these modes are exclusive. Corpus can be pre-tokenized, or you can provide tokenization options for both source and target (or source only for language models) prefixing all tokenization options with <code>-tok_src_</code>, <code>-tok_tgt_</code> or <code>tok_</code>. For instance - the following commandlines use all the files from <code>baseline</code> directory with source <code>.en</code> suffix and target <code>.fr</code> suffix. The source is tokenized in aggressive mode, and is using case feature, while the target is tokenized in aggressive mode and limited to 30 words sequences.</p>
<div class="codehilite"><pre><span></span>th train.lua
  -train_dir baseline
  -src_suffix .en -tgt_suffix .fr
  -tok_src_mode aggressive -tok_src_case_feature
  -tok_tgt_mode aggressive
  -tgt_seq_length 30
  -save_model baseline
</pre></div>


<p>The available options are <code>preprocess.lua</code> options documented <a href="http://opennmt.net/OpenNMT/options/preprocess/">here</a> and <code>tokenize.lua</code> options documented <a href="http://opennmt.net/OpenNMT/options/tokenize/">here</a>.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>It is simpler (and faster) to use dynamic dataset associated with file sampling when working on corpus with more than 10 million sentences.</p>
</div>
<h3 id="sampling-distribution-rules">Sampling distribution rules<a class="headerlink" href="#sampling-distribution-rules" title="Permanent link">&para;</a></h3>
<p>When the set of training files is heterogenous, you can specify the proportion of each file using a distribution rule file specified with <code>-gsample_dist FILE</code> option.</p>
<p>The rule file is list of rule in each line applied. A rule is a <code>LuaPattern SPACE WEIGHT</code>. The first rule in the file matching (with <code>LuaPattern</code> a filename) is applied for the file. <code>LuaPattern</code> can be a lua regex (see <a href="https://www.lua.org/pil/20.2.html">https://www.lua.org/pil/20.2.html</a>) or <code>*</code> matching everything.</p>
<p>For instance, let us say you have the following files in your <code>train_dir</code> directory:</p>
<div class="codehilite"><pre><span></span>generic.src, generic.tgt
IT1.src, IT1.tgt
IT2.src, IT2.tgt
MSDN.src, MSDN.tgt
colloquial.src, colloquial.tgt
news.src, news.tgt
</pre></div>


<p>and using the following rules:</p>
<div class="codehilite"><pre><span></span>IT,MSDN 20
colloquial 10
generic 65
* 5
</pre></div>


<p>The following rules apply:</p>
<ul>
<li><code>generic 65</code> matches <code>generic.{src,tgt}</code></li>
<li><code>IT,MSDN 20</code> matches <code>IT{1,2}.{src,tgt}</code> and <code>MSDN.{src,tgt}</code></li>
<li><code>colloquial 10</code> matches <code>colloquial.{src,tgt}</code></li>
<li><code>* 5</code> maches <code>news.{src,tgt}</code></li>
</ul>
<p>The weights are dynamically normalized to 1. Here we will make sure that 65% of the sample will be composed of sentences from <code>generic.{src,tgt}</code> and only 20% from <code>IT{1,2}.{src,tgt}</code> and <code>MSDN.{src,tgt}</code>. To build the sample, the sampling preparation algorithm might oversample some of the corpus if is too small.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If one file could not be match by a rule, it would be completely excluded.</p>
</div>
<p>To test your distribution rules, it is possible to execute a dry run of the preprocessor:</p>
<div class="codehilite"><pre><span></span>th preprocess.lua -gsample_dist rules.txt -gsample <span class="m">100000</span> -train_dir data/ -dry_run
</pre></div>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../decay/" title="Decay strategies" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Decay strategies
              </span>
            </div>
          </a>
        
        
          <a href="../../translation/inference/" title="Inference" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Inference
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="http://opennmt.net" class="md-footer-social__link fa fa-globe"></a>
    
      <a href="https://github.com/OpenNMT/OpenNMT" class="md-footer-social__link fa fa-github"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application-f3ab9e5ff8.js"></script>
      
      
      <script>app.initialize({url:{base:"../.."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
      
        <script src="https://github.com/OpenNMT/OpenNMT/js/version-select.js"></script>
      
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.4/js/select2.min.js"></script>
      
    
    
      
      <script>!function(e,t,a,n,o,c,i){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,c=t.createElement(a),i=t.getElementsByTagName(a)[0],c.async=1,c.src=n,i.parentNode.insertBefore(c,i)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-89222039-1","opennmt.net"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var t=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",t,e.href)})});var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})</script>
      
    
  </body>
</html>